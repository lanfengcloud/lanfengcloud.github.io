<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Worker简述 | 花椒和邻居&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/87452.png">
    <meta name="description" content="web前端技术博客,花椒和邻居sBlog,持续专注web前端学习与总结。Cesium,markdown,JavaScript,js,ES6,TypeScript,vue,React,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.11b57309.css" as="style"><link rel="preload" href="/assets/js/app.b27ac3ca.js" as="script"><link rel="preload" href="/assets/js/2.4651773a.js" as="script"><link rel="preload" href="/assets/js/38.9c9c5f69.js" as="script"><link rel="prefetch" href="/assets/js/10.ce591752.js"><link rel="prefetch" href="/assets/js/11.b3b332f5.js"><link rel="prefetch" href="/assets/js/12.f5a1836d.js"><link rel="prefetch" href="/assets/js/13.7ee8c39c.js"><link rel="prefetch" href="/assets/js/14.286a6768.js"><link rel="prefetch" href="/assets/js/15.2f79ae5a.js"><link rel="prefetch" href="/assets/js/16.1ccfaf3d.js"><link rel="prefetch" href="/assets/js/17.b9644e7b.js"><link rel="prefetch" href="/assets/js/18.02c9e60c.js"><link rel="prefetch" href="/assets/js/19.1d3312d9.js"><link rel="prefetch" href="/assets/js/20.33a2e48f.js"><link rel="prefetch" href="/assets/js/21.cbd55d73.js"><link rel="prefetch" href="/assets/js/22.17d94390.js"><link rel="prefetch" href="/assets/js/23.71f3318d.js"><link rel="prefetch" href="/assets/js/24.52e90323.js"><link rel="prefetch" href="/assets/js/25.b502869e.js"><link rel="prefetch" href="/assets/js/26.6f44735e.js"><link rel="prefetch" href="/assets/js/27.1d65aca3.js"><link rel="prefetch" href="/assets/js/28.98366502.js"><link rel="prefetch" href="/assets/js/29.aeaeb5e3.js"><link rel="prefetch" href="/assets/js/3.c999fa3c.js"><link rel="prefetch" href="/assets/js/30.b3434784.js"><link rel="prefetch" href="/assets/js/31.9a104273.js"><link rel="prefetch" href="/assets/js/32.b09ab3dc.js"><link rel="prefetch" href="/assets/js/33.906f5e48.js"><link rel="prefetch" href="/assets/js/34.65f2ade3.js"><link rel="prefetch" href="/assets/js/35.638ad7c5.js"><link rel="prefetch" href="/assets/js/36.16ab1509.js"><link rel="prefetch" href="/assets/js/37.851d308f.js"><link rel="prefetch" href="/assets/js/39.8da9fa39.js"><link rel="prefetch" href="/assets/js/4.d82326e8.js"><link rel="prefetch" href="/assets/js/40.252d8608.js"><link rel="prefetch" href="/assets/js/41.81e7aef1.js"><link rel="prefetch" href="/assets/js/42.c70af93c.js"><link rel="prefetch" href="/assets/js/43.acbd19b9.js"><link rel="prefetch" href="/assets/js/44.8db3762d.js"><link rel="prefetch" href="/assets/js/45.e2e6b96f.js"><link rel="prefetch" href="/assets/js/46.c2281ad8.js"><link rel="prefetch" href="/assets/js/47.9b4b10b9.js"><link rel="prefetch" href="/assets/js/48.4a87ce48.js"><link rel="prefetch" href="/assets/js/49.a2e7a0eb.js"><link rel="prefetch" href="/assets/js/5.1a2700dd.js"><link rel="prefetch" href="/assets/js/50.1e264e29.js"><link rel="prefetch" href="/assets/js/51.5b27ad72.js"><link rel="prefetch" href="/assets/js/52.f45fd595.js"><link rel="prefetch" href="/assets/js/53.151f1dbf.js"><link rel="prefetch" href="/assets/js/54.689022c8.js"><link rel="prefetch" href="/assets/js/55.e46d9867.js"><link rel="prefetch" href="/assets/js/56.dc2831a1.js"><link rel="prefetch" href="/assets/js/57.7072ff5d.js"><link rel="prefetch" href="/assets/js/58.54f07e7e.js"><link rel="prefetch" href="/assets/js/59.eafc095d.js"><link rel="prefetch" href="/assets/js/6.c4610236.js"><link rel="prefetch" href="/assets/js/60.314af2d6.js"><link rel="prefetch" href="/assets/js/61.3862b3af.js"><link rel="prefetch" href="/assets/js/62.a4cccce2.js"><link rel="prefetch" href="/assets/js/63.dfc009ae.js"><link rel="prefetch" href="/assets/js/64.8f216c0d.js"><link rel="prefetch" href="/assets/js/65.2ee59ca3.js"><link rel="prefetch" href="/assets/js/66.8f64cabc.js"><link rel="prefetch" href="/assets/js/67.27f37898.js"><link rel="prefetch" href="/assets/js/68.6eea4628.js"><link rel="prefetch" href="/assets/js/69.b9654bda.js"><link rel="prefetch" href="/assets/js/7.a5bff2b9.js"><link rel="prefetch" href="/assets/js/70.97bf8b83.js"><link rel="prefetch" href="/assets/js/71.ba0a87e1.js"><link rel="prefetch" href="/assets/js/72.84b055cd.js"><link rel="prefetch" href="/assets/js/73.7ab818f4.js"><link rel="prefetch" href="/assets/js/74.2fac3511.js"><link rel="prefetch" href="/assets/js/75.688b385a.js"><link rel="prefetch" href="/assets/js/76.e5a15c1b.js"><link rel="prefetch" href="/assets/js/8.4ac93032.js"><link rel="prefetch" href="/assets/js/9.d31b45ba.js">
    <link rel="stylesheet" href="/assets/css/0.styles.11b57309.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="花椒和邻居's Blog" class="logo"> <span class="site-name can-hide">花椒和邻居's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/e58ecf/" class="nav-link">Java程序员</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/f2e63f.html" class="nav-link">随笔</a></div> <a href="https://github.com/rwerplus/rwerplus.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/ava.2gamq0p5pj8k.webp"> <div class="blogger-info"><h3>花椒和邻居</h3> <span>工作了三年半的前端实习生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/e58ecf/" class="nav-link">Java程序员</a></li></ul></div></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/f2e63f.html" class="nav-link">随笔</a></div> <a href="https://github.com/rwerplus/rwerplus.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端开发笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a61298/" class="sidebar-link">33个非常实用的JavaScript一行代码</a></li><li><a href="/pages/8143cc480faf9a11/" class="sidebar-link">new命令原理</a></li><li><a href="/pages/b1af5cb8996363c5/" class="sidebar-link">ES5面向对象</a></li><li><a href="/pages/1f4123be6f45abcd/" class="sidebar-link">ES6面向对象</a></li><li><a href="/pages/dcebaf/" aria-current="page" class="active sidebar-link">Service Worker简述</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/40b4db2d38ba85f2/" class="sidebar-link">JS随机打乱数组</a></li><li><a href="/pages/f1acb712033ac8da/" class="sidebar-link">将一维数组按指定长度转为二维数组</a></li><li><a href="/pages/fd4a16d56b83c1bc/" class="sidebar-link">比typeof运算符更准确的类型判断</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>3D地图相关</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/web/#前端" data-v-06225672>前端</a></li><li data-v-06225672><a href="/web/#JavaScript" data-v-06225672>JavaScript</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/rwerplus" target="_blank" title="作者" class="beLink" data-v-06225672>花椒和邻居</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-11-04</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Service Worker简述<span class="title-tag">原创</span></h1>  <div class="theme-vdoing-content content__default"><h1 id="虽然云q同学由于工作原因-好久没有更新了。-虽然有很多想分享的"><a href="#虽然云q同学由于工作原因-好久没有更新了。-虽然有很多想分享的" class="header-anchor">#</a> 虽然云Q同学由于工作原因，好久没有更新了。(虽然有很多想分享的)</h1> <p align="center"><img src="https://cdn.jsdelivr.net/gh/rwerplus/rwerplus.github.io@master/20220225/xxx.mrtsg0up228.webp" width="500" style="cursor:zoom-in;"></p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>今天的文章有点长，如果你没时间一次性读完，建议先收藏</p></div> <h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p><code>由于最近使用语雀比较频繁，偶然一次点进去语雀的源码看到了serviceWorker，便产生了好奇去研究</code></p> <p>丰富的离线体验、定期的后台同步以及推送通知等通常需要将面向本机应用的功能将引入到网页应用中。Service Worker 提供所有这些功能所依赖的技术基础。</p> <hr> <h3 id="什么是service-worker"><a href="#什么是service-worker" class="header-anchor">#</a> 什么是Service Worker</h3> <p>Service Worker 是浏览器在后台独立于网页运行的脚本，它打开了通向不需要网页或用户交互的功能的大门。现在，它们已包括如推送通知和后台同步等功能。将来，Service Worker 将会支持如定期同步或地理围栏等其他功能。
在 Service Worker 出现前，存在能够在网络上为用户提供离线体验的另一个 API，称为 AppCache。AppCache API 存在的许多相关问题，在设计 Service Worker 时已予以避免。</p> <p><strong>Service Worker 相关注意事项:</strong></p> <ul><li>它是一种 JavaScript Worker，无法直接访问 DOM。Service Worker 通过响应 postMessage 接口发送的消息来与其控制的页面通信，页面可在必要时对 DOM 执行操作。</li> <li>Service Worker 是一种可编程网络代理，让您能够控制页面所发送网络请求的处理方式。</li> <li>Service Worker 在不用时会被中止，并在下次有需要时重启，因此，您不能依赖 Service Worker onfetch 和 onmessage 处理程序中的全局状态。如果存在您需要持续保存并在重启后加以重用的信息，Service Worker 可以访问 IndexedDB API。</li> <li>Service Worker 广泛地利用了 promise</li></ul> <hr> <h3 id="service-worker生命周期"><a href="#service-worker生命周期" class="header-anchor">#</a> Service Worker生命周期</h3> <p>Service Worker 的生命周期完全独立于网页。</p> <p>要为网站安装服务工作线程，您需要先在页面的 JavaScript 中注册。注册服务工作线程将会导致浏览器在后台启动服务工作线程安装步骤。</p> <p>在安装过程中，通常需要缓存某些静态资产。如果所有文件均已成功缓存，那么 Service Worker 就安装完毕。如果任何文件下载失败或缓存失败，那么安装步骤将会失败，Service Worker 就无法激活（也就是说， 不会安装）。如果发生这种情况，不必担心，它下次会再试一次。但这意味着，如果安装完成，便知道已在缓存中有哪些静态资产。</p> <p>安装之后，接下来就是激活步骤，这是管理旧缓存的绝佳机会，后面将在 Service Worker 的更新部分对此详加介绍。</p> <p>激活之后，Service Worker 将会对其作用域内的所有页面实施控制，不过，首次注册该 Service Worker 的页面需要再次加载才会受其控制。服务工作线程实施控制后，它将处于以下两种状态之一: 服务工作线程终止以节省内存，或处理获取和消息事件，从页面发出网络请求或消息后将会出现后一种状态。</p> <p>以下为简化的生命周期：
</p><p align="center"><img src="https://cdn.jsdelivr.net/gh/rwerplus/rwerplus.github.io@dev/Улла.1ayxscy4j4ps.webp" width="500" style="cursor:zoom-in;"></p><p></p> <div class="custom-block right"><p>图片来源于 <a href="https://www.google.com/" target="_blank" rel="noopener noreferrer">google<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 开发</p></div> <ul><li><h4 id="先决条件"><a href="#先决条件" class="header-anchor">#</a> 先决条件</h4></li> <li><p><em><strong>浏览器支持</strong></em></p></li></ul> <p>可用的浏览器日益增多。Service Worker 受 Chrome、Firefox 和 Opera 支持。Microsoft Edge 现在表示公开支持。甚至 Safari 也暗示未来会进行相关开发。您可以在 Jake Archibald 的 is Serviceworker ready 网站上查看所有浏览器的支持情况 。</p> <ul><li><em><strong>需要HTTPS/localhost</strong></em></li></ul> <p>在开发过程中，可以通过 localhost 使用 Service Worker，但如果要在网站上部署 Service Worker，则需要在服务器上设置 HTTPS。</p> <p>使用服务工作线程，您可以劫持连接、编撰以及过滤响应。这是一个很强大的工具。您可能会善意地使用这些功能，但中间人可会将其用于不良目的。为避免这种情况，可仅在通过 HTTPS 提供的页面上注册 Service Worker，如此我们便知道浏览器接收的 Service Worker 在整个网络传输过程中都没有被篡改。</p> <p>如果想要向服务器添加 HTTPS，您需要获得 TLS 证书并在服务器上进行设置。具体因您的设置而异，因此请查看服务器的文档，并务必查阅 Mozilla SSL 配置生成器，了解最佳做法。</p> <ul><li><h4 id="注册service-worker"><a href="#注册service-worker" class="header-anchor">#</a> 注册Service Worker</h4></li></ul> <p>若要安装 Service Worker，您需要通过在页面中对其进行注册来启动安装。这将告诉浏览器 Service Worker JavaScript 文件的位置。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Registration was successful</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker registration successful with scope: '</span><span class="token punctuation">,</span> registration<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// registration failed :(</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker registration failed: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>此代码用于检查 Service Worker API 是否可用，如果可用，则在页面加载后注册位于 /sw.js 的 Service Worker。</p> <p>每次页面加载无误时，即可调用 register()；浏览器将会判断服务工作线程是否已注册并做出相应的处理。</p> <p>register() 方法的精妙之处在于服务工作线程文件的位置。您会发现在本例中服务工作线程文件位于根网域。这意味着服务工作线程的作用域将是整个来源。换句话说，Service Worker 将接收此网域上所有事项的 fetch 事件。如果我们在 /example/sw.js 处注册 Service Worker 文件，则 Service Worker将只能看到网址以/example/ 开头(即/example/page1/、/example/page2/)的页面的 fetch 事件。</p> <p>现在，您可以通过转至 chrome://inspect/#service-workers 并寻找您的网站来检查 Service Worker 是否已启用。</p> <p><img src="https://cdn.jsdelivr.net/gh/rwerplus/rwerplus.github.io@dev/ertt.49fjuodxzhk0.webp" alt="00"></p> <p>首次实施 Service Worker 时，您还可以通过 chrome://serviceworker-internals 来查看 Service Worker 详情。如果只是想了解 Service Worker 的生命周期，这仍很有用，但是日后其很有可能被 chrome://inspect/#service-workers 完全取代。</p> <p>您会发现，它还可用于测试隐身窗口中的服务工作线程，您可以关闭服务工作线程并重新打开，因为之前的服务工作线程不会影响新窗口。从无痕式窗口创建的任何注册和缓存在该窗口关闭后均将被清除。</p> <ul><li><h4 id="安装service-worker"><a href="#安装service-worker" class="header-anchor">#</a> 安装Service Worker</h4></li></ul> <p>在受控页面启动注册流程后，我们来看看处理 install 事件的 Service Worker 脚本。</p> <p>最基本的例子是，您需要为安装事件定义回调，并决定想要缓存的文件。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Perform install steps</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在 install 回调的内部，我们需要执行以下步骤:</p> <div class="language-markdown line-numbers-mode"><pre class="language-markdown"><code> 打开缓存。
 缓存文件;
 确认所有需要的资产是否已缓存;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token constant">CACHE_NAME</span> <span class="token operator">=</span> <span class="token string">'my-site-cache-v1'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> urlsToCache <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'/'</span><span class="token punctuation">,</span>
  <span class="token string">'/styles/main.css'</span><span class="token punctuation">,</span>
  <span class="token string">'/script/main.js'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Perform install steps</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Opened cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>urlsToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li><p>此处，我们以所需的缓存名称调用 caches.open()，之后再调用 cache.addAll() 并传入文件数组。这是一个 promise 链（caches.open() 和 cache.addAll()）。 event.waitUntil() 方法带有 promise 参数并使用它来判断安装所花费的时间，以及安装是否成功。</p></li> <li><p>如果所有文件都成功缓存，则将安装 Service Worker。如有任何文件无法下载，则安装步骤将失败。这可让您依赖于所定义的所有资产，但也意味着需要对您决定在安装步骤缓存的文件列表格外留意。定义一个过长的文件列表将会增加文件缓存失败的几率，从而导致服务工作线程未能安装。</p></li> <li><p>这仅是一个示例，实际您可以在 install 事件中执行其他任务，或完全避免设置 install 事件侦听器。</p></li> <li><h4 id="缓存和返回请求"><a href="#缓存和返回请求" class="header-anchor">#</a> 缓存和返回请求</h4></li></ul> <p>您已安装 Service Worker，现在可能会想要返回一个缓存的响应，对吧？</p> <p>在安装 Service Worker 且用户转至其他页面或刷新当前页面后，Service Worker 将开始接收 fetch 事件。下面提供了一个示例。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cache hit - return response</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><p>这里我们定义了 fetch 事件，并且在 event.respondWith() 中，我们传入来自 caches.match() 的一个 promise。此方法检视该请求，并从服务工作线程所创建的任何缓存中查找缓存的结果。</p></li> <li><p>如果发现匹配的响应，则返回缓存的值，否则，将调用 fetch 以发出网络请求，并将从网络检索到的任何数据作为结果返回。这是一个简单的例子，它使用了在安装步骤中缓存的所有资产。</p></li> <li><p>如果希望连续缓存新请求，可以通过处理 fetch 请求的响应并将其添加到缓存来实现，如下所示。</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Cache hit - return response</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// IMPORTANT:Clone the request. A request is a stream and</span>
        <span class="token comment">// can only be consumed once. Since we are consuming this</span>
        <span class="token comment">// once by cache and once by the browser for fetch, we need</span>
        <span class="token comment">// to clone the response.</span>
        <span class="token keyword">var</span> fetchRequest <span class="token operator">=</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
          <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Check if we received a valid response</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>response <span class="token operator">||</span> response<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span> <span class="token operator">||</span> response<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'basic'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// IMPORTANT:Clone the response. A response is a stream</span>
            <span class="token comment">// and because we want the browser to consume the response</span>
            <span class="token comment">// as well as the cache consuming the response, we need</span>
            <span class="token comment">// to clone it so we have two streams.</span>
            <span class="token keyword">var</span> responseToCache <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> responseToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><em><strong>执行的操作如下:</strong></em></p> <div class="language-markdown line-numbers-mode"><pre class="language-markdown"><code>在 fetch 请求中添加对 .then() 的回调。

获得响应后，执行以下检查:

<span class="token list punctuation">-</span> 确保响应有效。

<span class="token list punctuation">-</span> 检查并确保响应的状态为 200。

<span class="token list punctuation">-</span> 确保响应类型为 basic，亦即由自身发起的请求。这意味着，对第三方资产的请求也不会添加到缓存。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li><p>如果通过检查，则克隆响应。这样做的原因在于，该响应是数据流， 因此主体只能使用一次。由于我们想要返回能被浏览器使用的响应，并将其传递到缓存以供使用，因此需要克隆一份副本。我们将一份发送给浏览器，另一份则保留在缓存。</p></li> <li><h4 id="更新service-worker"><a href="#更新service-worker" class="header-anchor">#</a> 更新Service Worker</h4></li></ul> <p>在某个时间点，您的 Service Worker 需要更新。此时，您需要遵循以下步骤:</p> <div class="language-markdown line-numbers-mode"><pre class="language-markdown"><code><span class="token list punctuation">-</span> 更新您的服务工作线程 JavaScript 文件。用户导航至您的站点时，浏览器会尝试在后台重新下载定义 Service Worker 的脚本文件。如果 Service Worker 文件与其当前所用文件存在字节差异，则将其视为新 Service Worker。

<span class="token list punctuation">-</span> 新 Service Worker 将会启动，且将会触发 install 事件。

<span class="token list punctuation">-</span> 此时，旧 Service Worker 仍控制着当前页面，因此新 Service Worker 将进入 waiting 状态。

<span class="token list punctuation">-</span> 当网站上当前打开的页面关闭时，旧 Service Worker 将会被终止，新 Service Worker 将会取得控制权。

<span class="token list punctuation">-</span> 新 Service Worker 取得控制权后，将会触发其 activate 事件。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>出现在 activate 回调中的一个常见任务是缓存管理。您希望在 activate 回调中执行此任务的原因在于，如果您在安装步骤中清除了任何旧缓存，则继续控制所有当前页面的任何旧 Service Worker 将突然无法从缓存中提供文件。</p> <p>比如说我们有一个名为 'my-site-cache-v1' 的缓存，我们想要将该缓存拆分为一个页面缓存和一个博文缓存。这就意味着在安装步骤中我们创建了两个缓存: 'pages-cache-v1' 和 'blog-posts-cache-v1'，且在激活步骤中我们要删除旧的 'my-site-cache-v1'。</p> <p>以下代码将执行此操作，具体做法为: 遍历 Service Worker 中的所有缓存，并删除未在缓存白名单中定义的任何缓存。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> cacheAllowlist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'pages-cache-v1'</span><span class="token punctuation">,</span> <span class="token string">'blog-posts-cache-v1'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        cacheNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheAllowlist<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="瑕疵与问题"><a href="#瑕疵与问题" class="header-anchor">#</a> 瑕疵与问题</h3> <p><strong>如果 Worker注册后未在 chrome://inspect/#service-workers 或 chrome://serviceworker-internals 中显示，则有可能是引发错误或向 event.waitUntil() 发送被拒绝的 promise 而导致无法安装。</strong></p> <p>要解决该问题，请转至 chrome://serviceworker-internals 并勾选“Open DevTools window and pause JavaScript execution on service worker startup for debugging”，然后将调试程序语句置于安装事件开始处。这与未捕获异常中的暂停共同揭露问题。</p> <p>使用 fetch 时，默认情况下请求中不包含 Cookie 等凭据。如需凭据，改为调用</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'include'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这一行为是有意为之，可以说比 XHR 更复杂的以下默认行为更好: 如果网址具有相同来源，则默认发送凭据，否则忽略。提取的行为更接近于其他 CORS 请求，如 <img crossorigin="">，它将决不会发送 Cookie，除非您使用 <img crossorigin="use-credentials"> 选择加入。</p> <p><em><strong>非 CORS 默认失败</strong></em></p> <p>默认情况下，从不支持 CORS 的第三方网址中提取资源将会失败。您可以向请求中添加 no-CORS 选项来克服此问题，不过这可能会导致“不透明”的响应，这意味着您无法辨别响应是否成功。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>urlsToPrefetch<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">urlToPrefetch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">returnnewRequest</span><span class="token punctuation">(</span>urlToPrefetch<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'All resources have been fetched and cached.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><em><strong>处理响应式图像</strong></em></p> <p>srcset 属性或 <picture></picture> 元素将在运行期间选择最适当的图像资产，并发出网络请求。</p> <p>对于 Service Worker，如果您想要在安装过程中缓存图像，您有下列几种选择:</p> <div class="language-markdown line-numbers-mode"><pre class="language-markdown"><code>安装 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">&gt;</span></span> 元素和 srcset 属性将请求的所有图像。

安装一个低分辨率版本的图像。

安装一个高分辨率版本的图像。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实际上，您应该选择 2 或 3，因为下载所有图像会浪费存储空间。</p> <p>假定您在安装期间选择安装低分辨率版本的图像，在页面加载时您想要尝试从网络中检索高分辨率的图像，但是如果检索高分辨率版本失败，则回退到低分辨率版本。这没有问题，而且这种做法很好，但是有另外一个问题。</p> <p>如果我们有以下两张图像:</p> <table><thead><tr><th style="text-align:center;">屏幕密度</th> <th style="text-align:center;">宽度</th> <th style="text-align:center;">高度</th></tr></thead> <tbody><tr><td style="text-align:center;">1x</td> <td style="text-align:center;">400</td> <td style="text-align:center;">400</td></tr> <tr><td style="text-align:center;">2x</td> <td style="text-align:center;">800</td> <td style="text-align:center;">800</td></tr></tbody></table> <p>在 srcset 图像中，我们有一些像这样的标记:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image-src.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image-src.png 1x, image-2x.png 2x<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果我们使用的是 2x 显示屏，浏览器将会选择下载 image-2x.png。如果我们处于离线状态，您可以对请求执行 .catch() 并返回 image-src.png（如已缓存）。但是，浏览器会期望 2x 屏幕上的图像有额外的像素，这样图像将显示为 200x200 CSS 像素而不是 400x400 CSS 像素。解决该问题的唯一办法是设定固定的图像高度和宽度。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image-src.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image-src.png 1x, image-2x.png 2x<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>400px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><em><strong>对于要用于艺术指导的 <picture></picture> 元素，这会变得相当困难，而且很大程度上取决于图像的创建和使用方式，但是您可以使用类似于 srcset 的方法</strong></em></p> <ul><li><h3 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h3> <ul><li>预加载 &amp;&amp; 离线化</li></ul> <p>打开语雀官网就可以看到<a href="https://www.yuque.com/" target="_blank" rel="noopener noreferrer">https://www.yuque.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，首次是从网络请求，但是第二次进入后便是通过serviceworker读取</p> <p>访问开发者后台的service-worker.js查看源代码</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>self<span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/common.b4c03be5.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/common.e2d71ce8.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__components__Explore__Recommend~p__explore__routers__Docs~p__explore__routers__Repos~p_~d6257766.aa1bcc43.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__components__Explore__Recommend~p__explore__routers__Docs~p__explore__routers__Repos~p_~d6257766.fac19d5b.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/c__Lakex~p__editor__routers__TextEditor.9defba11.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/c__Lakex~p__editor__routers__TextEditor.3a98afb8.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers.244d87f7.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers.ef3c862f.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/c__Lakex.acd5cec4.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/c__Lakex.653d1e93.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/layout__MainLayout.ae548301.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/layout__MainLayout.c0075e36.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__model.511a24e3.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers__EditCustomIndex.d4fbfe9e.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers__EditCustomIndex.28048163.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers__ShareExpired.8113c1a2.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers__ShareExpired.b6dff962.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers__SharePassword.1a6ae926.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__bookRepo__routers__SharePassword.f76c7685.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__components__Explore__Events.6d43e196.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__components__Explore__Events.979d04c6.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__components__Explore__Recommend.ab8c57cb.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__components__Explore__Recommend.ac025d9d.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__model.2d27d4bc.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__App.4d4a0a8c.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__App.08fcac15.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__CollabBooks.40627926.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__CollabBooks.91d8d56d.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Collects.0a516ca7.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Collects.b5f172fe.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Dashboard.5f89b7f3.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Dashboard.be7c1714.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Explore.b51bb073.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Groups.198f522b.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Groups.ad67b3b7.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__History.086ddd9c.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__History.5387e7a8.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__MyBooks.40627926.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__MyBooks.61608f6e.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Notes.a878e2d7.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Notes.ffe2cc7a.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Recycles.ab448ca1.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__dashboard__routers__Recycles.3434b09c.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__doc__model__page.424fcfd2.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__doc__routers.66f72a35.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__doc__routers.39267068.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__doc__routers__version.e7b71a05.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__doc__routers__version.186ff53b.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__model.7ef254a2.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__Asl.60282b53.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__Asl.fa585dad.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__TextEditor.f413dbfc.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__TextEditor.81c5d11d.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__board.591d841b.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__board.832f1003.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__doc.a1ccd84d.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__doc.e652cf65.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__embed.500645af.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__embed.743631c5.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__embed_extreme.5563bfd4.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__embed_extreme.88434cbe.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__sheet.8a86af45.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__sheet.2daf2fb0.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__show.75463f8e.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__show.14157f9c.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__table.60aad9c2.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__editor__routers__table.29a799ed.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__model.263db0b2.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Books.cfc93cd2.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Books.8ffd07d8.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Custom.710dc957.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Custom.604bf4aa.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Embed.daf129f3.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Embed.1a8cd333.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Error403.8113c1a2.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Error403.e426da8e.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Group.a1fbd1b1.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Group.aca6ba40.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Members.c73713ca.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Members.fc9d4e92.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Migrate.e821f2d6.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Migrate.c5718315.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Recycles.724821a4.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Recycles.9b99a94d.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Statistics.e849f2e3.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Statistics.e2b4dc68.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Upgrade.a42075c1.chunk.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/p__group__routers__Upgrade.d80c9df1.async.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/lib/??react/16.13.1/umd/react.production.min.js,react-dom/16.13.1/umd/react-dom.production.min.js,react-dom/16.13.1/umd/react-dom-server.browser.production.min.js,moment/2.24.0/min/moment.min.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/as/g/larkgroup/lake-codemirror/6.0.2/CodeMirror.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/as/g/larkgroup/lark-sheet/11.0.20/lark-sheet.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/a/g/lark/??immutable/3.8.2/immutable.min.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/as/g/larkgroup/lark-sheet/11.0.20/lark-sheet.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span>resourceBase <span class="token operator">=</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/chair-script/skylark/&quot;</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;install&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//预加载常用资源</span>
    Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>assets<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;activate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//过期资源释放</span>
        self<span class="token punctuation">.</span>assets<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>resourceBase<span class="token punctuation">,</span> <span class="token string">&quot;https://at.alicdn.com/t/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://gw.alipayobjects.com/os/&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//拦截资源，满足上述域名，优先使用缓存，否则使用网络下载资源并更新资源。</span>
  r<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> e<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t <span class="token operator">&amp;&amp;</span> <span class="token number">200</span> <span class="token operator">===</span> t<span class="token punctuation">.</span>status <span class="token operator">?</span> t <span class="token operator">:</span> <span class="token function">fetch</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">!==</span> t<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token keyword">const</span> r <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>request<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>此处只是访问首页，Cache 就已经加载了大量的 js 资源和 css 资源，总缓存占据了 64 MB，作为一个偏展示型官网，加载 64MB 显示是不科学的，更合理的解释是，在不堵塞用户使用的情况，优先缓存了后续页面所需要使用的 js 文件来加速后续页面的打开速度，比如其 TextEditor 组件就是为了后续的编辑页提前缓存的：</p> <ul><li><p>其它预加载使用场景</p> <p>那么现在换为移动App的场景，以一个复杂的页面为例，如果Boss 今天给你的任务是秒开该工作台应用下的一个子应用，包括第一次打开，如何利用 ServiceWorker 来做到?</p></li> <li><p>错误页面</p></li></ul> <p>当你的某个重要资源无法从网络下载时，可以使用降级策略，返回到一个 Error 页面，这个 Error 页面可以是你事先缓存的一个资源。</p> <p>以上面提到的工作台场景为例，移动端最常见的故障是子应用白屏，子应用白屏时会在进入正常页面之前产生出完全白色的界面，原因是下一个页面的某个 html 或者 js 资源获取异常或者加载时间很漫长，导致了页面白屏。</p> <p>如果使用了ServiceWorker 拦截了请求，就可以在无法正常返回资源的时候返回给前台一个error页面，当前如果把 error 链接设置成一个动态地址，我们就可以实现在后台做到各种策略的优雅降级了。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/rwerplus/rwerplus.github.io/edit/master/docs/01.前端/25.JavaScript/10.Service Worker简述.md" target="_blank" rel="noopener noreferrer">去GitHub编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=JavaScript" title="标签">#JavaScript</a><a href="/tags/?tag=%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7" title="标签">#实用技巧</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/11/09, 03:51:49</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1f4123be6f45abcd/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">ES6面向对象</div></a> <a href="/pages/40b4db2d38ba85f2/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">JS随机打乱数组</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1f4123be6f45abcd/" class="prev">ES6面向对象</a></span> <span class="next"><a href="/pages/40b4db2d38ba85f2/">JS随机打乱数组</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/49a69e/"><div>
            为什么小程序特立独行
            <!----></div></a> <span class="date">04-23</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/f761ed/"><div>
            单页应用与前端路由库设计原理
            <!----></div></a> <span class="date">04-23</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/596343/"><div>
            代码构建与 Webpack 必备技能
            <!----></div></a> <span class="date">04-23</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:localfeng@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/rwerplus" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=88954294" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>花椒和邻居 | <a href="https://github.com/rwerplus/rwerplus.github.io/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.b27ac3ca.js" defer></script><script src="/assets/js/2.4651773a.js" defer></script><script src="/assets/js/38.9c9c5f69.js" defer></script>
  </body>
</html>
